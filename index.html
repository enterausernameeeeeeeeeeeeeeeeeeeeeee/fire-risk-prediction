<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì „ê¸° ê²½ë³´ ì§€ë„</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <link rel="stylesheet" href="https://openlayers.org/en/v6.15.1/css/ol.css" />
  <script src="https://openlayers.org/en/v6.15.1/build/ol.js"></script>
  <style>
    #map { width: 100%; height: 90vh; }
    #controls {
      padding: 10px;
      background: #f4f4f4;
      border-bottom: 1px solid #ccc;
    }
    .ol-popup {
      background: white;
      border: 1px solid black;
      padding: 10px;
      position: absolute;
      bottom: 12px;
      left: -50px;
      min-width: 250px;        /* ë„ˆë¹„ ë„‰ë„‰í•˜ê²Œ */
      max-width: 350px;        /* ë„ˆë¬´ ì»¤ì§€ëŠ” ê²ƒë„ ì œí•œ */
      white-space: normal;     /* í‘œ ì•ˆì˜ ì…€ì€ ì¤„ë°”ê¿ˆ í—ˆìš© */
      word-break: keep-all;    /* í…ìŠ¤íŠ¸ê°€ ë‹¨ì–´ ë‹¨ìœ„ë¡œ ì¤„ë°”ê¿ˆ ë˜ê²Œ */
    }
  </style>
</head>
<body>
  <div id="controls">
    ë‚ ì§œ ì„ íƒ: <input type="date" id="date" />
    ì‹œê°„ ì„ íƒ:
    <select id="hour">
      <script>
        for (let i = 0; i < 24; i++) {
          document.write(`<option value="${i.toString().padStart(2, '0')}">${i}ì‹œ</option>`);
        }
      </script>
    </select>
  </div>

  <div id="map"></div>

  <script>
    let allFeatures = [];
    const vectorSource = new ol.source.Vector();
    const vectorLayer = new ol.layer.Vector({
      source: vectorSource,
      
      style: function (feature) {
      let color = feature.get('ìƒ‰ìƒ');

      //  ë¹¨ê°„ìƒ‰: ì „ê¸° ê²½ë³´ + ë‚ ì”¨ ìœ„í—˜
      if (color === 'ë¹¨ê°„ìƒ‰') color = 'red';
      else if (color === 'ì£¼í™©ìƒ‰') color = 'orange';
      else if (color === 'ë…¸ë€ìƒ‰') color = 'yellow';
      else if (color === 'ì´ˆë¡ìƒ‰') color = 'green';
      else color = 'gray'; // ì˜ˆì™¸ ì²˜ë¦¬

      return new ol.style.Style({
        image: new ol.style.Circle({
          radius: 6,
          fill: new ol.style.Fill({ color: color }),
          stroke: new ol.style.Stroke({ color: '#000', width: 1 })
        })
      });
    }


    });

    const map = new ol.Map({
      target: 'map',
      layers: [
        new ol.layer.Tile({
          source: new ol.source.XYZ({
            url: 'https://xdworld.vworld.kr/2d/Base/service/{z}/{x}/{y}.png?apiKey=4F76721A-B984-3278-AD9F-05864AD8EF10',
            crossOrigin: 'anonymous'
          })
        }),
        vectorLayer
      ],
      view: new ol.View({
        center: ol.proj.fromLonLat([127.7669, 35.9078]),
        zoom: 7
      })
    });

    const popup = document.createElement('div');
    popup.className = 'ol-popup';
    const overlay = new ol.Overlay({
      element: popup,
      autoPan: true,
      autoPanAnimation: { duration: 250 }
    });
    map.addOverlay(overlay);

    // GeoJSON ë¡œë“œ
    $.getJSON('electric_alerts_with_coords.geojson', function(data) {
      allFeatures = new ol.format.GeoJSON().readFeatures(data, {
        featureProjection: 'EPSG:3857'
      });
    });

    // ê°€ì¥ ê°€ê¹Œìš´ ê²½ë³´ë§Œ í‘œì‹œ
    function showClosestPerDevice(date, hour) {
      const targetTime = new Date(`${date}T${hour}:00:00`);
      const closestMap = new Map();

      for (const f of allFeatures) {
        const timeStr = f.get('ê²½ë³´ ì¼ì‹œ');
        const device = f.get('ì¥ì¹˜ë²ˆí˜¸');
        if (!timeStr || !device) continue;

        const featureTime = new Date(timeStr.replace(' ', 'T'));
        const diff = Math.abs(featureTime - targetTime);

        const existing = closestMap.get(device);
        if (!existing || diff < existing.diff) {
          closestMap.set(device, { feature: f, diff });
        }
      }

      const closestFeatures = Array.from(closestMap.values()).map(e => e.feature);
      vectorSource.clear();
      vectorSource.addFeatures(closestFeatures);
      overlay.setPosition(undefined);
    }

    $('#date, #hour').on('change', function () {
      const date = $('#date').val();
      const hour = $('#hour').val();
      if (!date || !hour || allFeatures.length === 0) return;
      showClosestPerDevice(date, hour);
    });

    map.on('singleclick', function(evt) {
        overlay.setPosition(undefined);
        map.forEachFeatureAtPixel(evt.pixel, function(feature) {
            const messageType = feature.get('ë©”ì‹œì§€ ì¢…ë¥˜') || 'ì •ë³´ ì—†ìŒ';
            const timestamp = feature.get('ê²½ë³´ ì¼ì‹œ') || 'ì‹œê°„ ì •ë³´ ì—†ìŒ';
            const device = feature.get('ì¥ì¹˜ë²ˆí˜¸') || '';
            const signal = feature.get('ì´ìƒì‹ í˜¸') || '';
            const value = feature.get('ì¸¡ì •ê°’') || '';
            const risk = feature.get('ìœ„í—˜ìš”ì†Œ') || '';
            const alert = feature.get('ê²½ë³´ë°œìƒ') ? 'O' : 'X';
            const dewPoint = feature.get('ì´ìŠ¬ì ') || 'ì •ë³´ ì—†ìŒ';
            const humidity = feature.get('ìŠµë„') || 'ì •ë³´ ì—†ìŒ';
            const temperature  = feature.get('ê¸°ì˜¨') || 'ì •ë³´ ì—†ìŒ';
            const wind  = feature.get('í’ì†') || 'ì •ë³´ ì—†ìŒ';


            popup.innerHTML = `
              <div style="font-size:13px; font-family:Arial, sans-serif;">
                <div style="font-weight:bold; font-size:14px; margin-bottom:4px;">
                  ì¥ì¹˜ë²ˆí˜¸: <span style="word-break:keep-all;">${device}</span>
                </div>
                <table style="border-collapse:collapse; width:100%; border: 1px solid #ccc;">
                  <tr><td style="border: 1px solid #ccc; padding:4px;">ğŸ“… <strong>ë‚ ì§œ</strong></td><td style="border: 1px solid #ccc; padding:4px;">${timestamp}</td></tr>
                  <tr><td style="border: 1px solid #ccc; padding:4px;">âš¡ <strong>ì´ìƒì‹ í˜¸</strong></td><td style="border: 1px solid #ccc; padding:4px;">${signal}</td></tr>
                  <tr><td style="border: 1px solid #ccc; padding:4px;">ğŸ“ <strong>ì¸¡ì •ê°’</strong></td><td style="border: 1px solid #ccc; padding:4px;">${value}</td></tr>
                  <tr><td style="border: 1px solid #ccc; padding:4px;">ğŸŒ¡ï¸ <strong>ê¸°ì˜¨</strong></td><td style="border: 1px solid #ccc; padding:4px;">${temperature}</td></tr>
                  <tr><td style="border: 1px solid #ccc; padding:4px;">ğŸ’§ <strong>ì´ìŠ¬ì </strong></td><td style="border: 1px solid #ccc; padding:4px;">${dewPoint}</td></tr>
                  <tr><td style="border: 1px solid #ccc; padding:4px;">ğŸ’¦ <strong>ìŠµë„</strong></td><td style="border: 1px solid #ccc; padding:4px;">${humidity}</td></tr>
                  <tr><td style="border: 1px solid #ccc; padding:4px;">ğŸŒ¬ï¸ <strong>í’ì†</strong></td><td style="border: 1px solid #ccc; padding:4px;">${wind}</td></tr>
                  <tr><td style="border: 1px solid #ccc; padding:4px;">âš ï¸ <strong>ìœ„í—˜ìš”ì†Œ</strong></td><td style="border: 1px solid #ccc; padding:4px;">${risk}</td></tr>
                </table>
              </div>
            `;
            overlay.setPosition(evt.coordinate);
        });
        });
        
  </script>
</body>
</html>
